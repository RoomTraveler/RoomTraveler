<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.trip.map.MapDAO">

  <!-- 1) 관광지 기본 정보(위치 포함) 매핑 -->
  <resultMap id="RegionTripResDtoMap" type="com.ssafy.trip.map.MapDTO$RegionTripResDto">
    <id     property="no"        column="no"/>
    <result property="title"     column="title"/>
    <result property="image"     column="image"/>
    <result property="addr1"     column="addr1"/>
    <result property="addr2"     column="addr2"/>
    <result property="tel"       column="tel"/>
    <result property="latitude"  column="latitude"/>
    <result property="longitude" column="longitude"/>
  </resultMap>

<!--  <select id="getRegionTrip" resultMap="RegionTripResDtoMap">-->
<!--    SELECT no,-->
<!--           title,-->
<!--           first_image1 AS image,-->
<!--           addr1,-->
<!--           addr2,-->
<!--           tel,-->
<!--           latitude,-->
<!--           longitude-->
<!--      FROM attractions-->
<!--     WHERE si_gun_gu_code = #{gugunCode}-->
<!--       AND area_code  = #{sidoCode}-->
<!--  </select>-->

<!--  <select id="getInfoByLocalContent" resultMap="RegionTripResDtoMap">-->
<!--    SELECT no,-->
<!--           title,-->
<!--           first_image1 AS image,-->
<!--           addr1,-->
<!--           addr2,-->
<!--           tel,-->
<!--           latitude,-->
<!--           longitude-->
<!--      FROM attractions-->
<!--    WHERE si_gun_gu_code = #{gugunCode}-->
<!--      AND area_code  = #{sidoCode}-->
<!--       AND content_type_id = #{contentTypeId}-->
<!--  </select>-->

  <!-- 2) 시도/구군/컨텐츠타입 조회 -->
<!--  <resultMap id="SidoMap" type="com.ssafy.trip.map.MapDTO$Sido">-->
<!--    <result property="name" column="sido_name"/>-->
<!--    <result property="code" column="sido_code"/>-->
<!--  </resultMap>-->
<!--  <select id="getSidos" resultMap="SidoMap">-->
<!--    SELECT DISTINCT sido_name, sido_code FROM sidos-->
<!--  </select>-->

<!--  <resultMap id="GugunMap" type="com.ssafy.trip.map.MapDTO$Gugun">-->
<!--    <result property="name" column="gugun_name"/>-->
<!--      <result property="code" column="gugun_code"/>-->
<!--  </resultMap>-->
<!--  <select id="getGuguns" resultMap="GugunMap">-->
<!--    SELECT DISTINCT gugun_name, gugun_code-->
<!--    FROM guguns-->
<!--    WHERE sido_code = #{sido}-->
<!--  </select>-->

  <resultMap id="ContentTypeMap" type="com.ssafy.trip.map.MapDTO$ContentType">
    <result property="code" column="content_type_id"/>
    <result property="name" column="content_type_name"/>
  </resultMap>
  <select id="getContentTypes" resultMap="ContentTypeMap">
    SELECT content_type_id, content_type_name FROM contenttypes;
  </select>

  <!-- 3) 플랜 저장 및 조회 -->
  <insert id="insertPlan" parameterType="long" useGeneratedKeys="true" keyProperty="planId">
    INSERT INTO plan (user_id) VALUES (#{userId})
  </insert>

  <insert id="insertPlanAttractions" parameterType="map">
    INSERT INTO plan_attraction (plan_id, attraction_id, order_num)
    VALUES
    <foreach collection="attractionIds" item="id" index="idx" separator=",">
      (#{planId}, #{id}, #{idx})
    </foreach>
  </insert>

    <resultMap id="PlanWithAttractions" type="com.ssafy.trip.map.MapDTO$PlanDTO">
        <id property="planId" column="plan_id"/>
        <collection property="planAttractions" ofType="com.ssafy.trip.map.MapDTO$PlanAttractionDTO">
            <result property="attractionId" column="attraction_id"/>
            <result property="order"  column="order_num"/>
            <result property="title"  column="title"/>
        </collection>
    </resultMap>

    <select id="getPlans" resultMap="PlanWithAttractions">
        SELECT
            p.plan_id        AS plan_id,
            pa.attraction_id,
            pa.order_num,
            a.title,
            a.addr1,
            a.addr2,
            a.tel
        FROM plan p
                 JOIN plan_attraction pa  ON p.plan_id = pa.plan_id
                 JOIN attractions    a    ON pa.attraction_id = a.no
        WHERE p.user_id = #{userId}
        ORDER BY p.user_id, pa.order_num
    </select>

    <select id="getRegionTripWithinMapRange" resultMap="RegionTripResDtoMap">
        SELECT no,
            title,
            first_image1 AS image,
            addr1,
            addr2,
            tel,
            latitude,
            longitude
        FROM attractions
        WHERE latitude BETWEEN #{mapBound.southWest.latitude} AND #{mapBound.northEast.latitude}
          AND longitude BETWEEN #{mapBound.southWest.longitude} AND #{mapBound.northEast.longitude}
        LIMIT ${pageable.offset}, ${pageable.pageSize}
    </select>

    <select id="countRegionTrips" resultType="int">
        select count(*) as region_trip_count
        FROM attractions
        WHERE latitude BETWEEN #{southWest.latitude} AND #{northEast.latitude}
          AND longitude BETWEEN #{southWest.longitude} AND #{northEast.longitude}
    </select>

</mapper>
